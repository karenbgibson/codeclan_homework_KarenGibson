---
title: 'Manual model development'
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    df_print: paged
    css: ../../../styles.css
  pdf_document: default
editor_options: 
  chunk_output_type: console
---


```{r}
library(tidyverse)
library(modelr)
library(GGally)
library(ggfortify)
```

```{r}
kc_house <- read_csv("data/kc_house_data.csv")
```


# MVP


<div class="emphasis">
We want you to build an **explanatory model** for the `price` of housing in King County, i.e. an interpretable model in which the included variables are statistically justifiable.

The variable definitions are:

`id` - Unique ID for each home sold  
`date` - Date of the home sale  
`price` - Price of each home sold  
`bedrooms` - Number of bedrooms  
`bathrooms` - Number of bathrooms, where .5 accounts for a room with a toilet but no shower  
`sqft_living` - Square footage of the apartments interior living space  
`sqft_lot` - Square footage of the land space  
`floors` - Number of floors  
`waterfront` - A dummy variable for whether the apartment was overlooking the waterfront or not  
`view` - An index from 0 to 4 of how good the view of the property was  
`condition` - An index from 1 to 5 on the condition of the apartment  
`grade` - An index from 1 to 13, where 1-3 falls short of building construction and design, 7 has an average level of construction and design, and 11-13 have a high quality level of construction and design  
`sqft_above` - The square footage of the interior housing space that is above ground level  
`sqft_basement` - The square footage of the interior housing space that is below ground level  
`yr_built` - The year the house was initially built  
`yr_renovated` - The year of the houseâ€™s last renovation  
`zipcode` - What zipcode area the house is in  
`lat` - Lattitude  
`long` - Longitude  
`sqft_living15` - The square footage of interior housing living space for the nearest 15 neighbors  
`sqft_lot15` - The square footage of the land lots of the nearest 15 neighbors  
</div>
<br>

Explanatory vs Predictive model:
- explanatory: emphasis on simplicity, "parsimony", lean-ness, to enable us to understand a real world process
- predictive: emphasis on pure predictive power, e.g. objective measures like r2, etc. Don't care if it's easy/possible to understand "black box" 

Steps:
- explore - is price normally distributed? If not, do we want to log? 
- transform - feature engineering (drop data that is not necessary, look for and remove aliases, change variable to numeric, factors, etc.)

# Question 1

```{r}

kc_house_trimmed <- kc_house %>% 
  select(-c(date, id, sqft_living15, sqft_living15, sqft_lot15, zipcode)) %>% 
  mutate(waterfront = case_when(
    waterfront == 0 ~ TRUE,
    waterfront == 1 ~ FALSE
  )) %>% 
  mutate(renovated = if_else(
    yr_renovated == 0, TRUE, FALSE
  )) %>% 
  select(-yr_renovated)
```
    
`view`, `condition` and `grade` are all categorical ordinal data types. ***should have made these factors***

# Question 2

Check for aliased variables using the `alias()` function (this takes in a formula object and a data set). [**Hint** - formula `price ~ .` says 'price varying with all predictors', this is a suitable input to `alias()`]. Remove variables that lead to an alias. Check the 'Elements of multiple regression' lesson for a dropdown containing further information on finding aliased variables in a dataset.

```{r}
alias(price ~ ., kc_house_trimmed)
```
```{r}
kc_house_trimmed <- kc_house_trimmed %>% 
  select(-sqft_basement)
```


# Question 3

Systematically build a regression model containing up to **four** main effects (remember, a main effect is just a single predictor with coefficient), testing the regression diagnostics as you go.

<details>
<summary>**Hints**</summary>
```{r, eval=FALSE}
houses_tidy_numeric <- kc_house_trimmed %>%
  select_if(is.numeric)

#lambda function (throwaway function)
houses_tidy_nonnumeric <- kc_house_trimmed %>%
  select_if(function(x) !is.numeric(x)) # how does this work?

#newer method of above: select_if(\(x) !is.numeric(x))

houses_tidy_nonnumeric$price <- kc_house_trimmed$price

ggpairs(houses_tidy_numeric, progress = FALSE)
ggsave("ggpairsnumeric.png",
       width = 7,
       height = 7)
ggpairs(houses_tidy_nonnumeric)
ggsave("ggpairsnonumeric.png",
       width = 7,
       height = 7)
```
and the same in subsequent rounds of predictor selection with the `resid` column.<br><br>
Remember, if you are not sure whether including a categorical predictor is statistically justified, run an `anova()` test passing in the models with- and without the categorical predictor and check the p-value of the test.
</details>

Numeric variables that are highly correlated with price: 

- sqft living (0.7) #should be removed
- grade (0.67) #should be factor
- sqft above (0.6)
- bathrooms (0.53) # not as significantly important as other factors

Non-numeric variables that are highly correlated with price:
- waterfront # yes, look at this
- grade # should be factor so should be showing here

Predictor 1: sqft_living
```{r}
mod1 <- lm(price ~ sqft_living,
           data = kc_house_trimmed)

summary(mod1)
```

r-squared: 0.49, residual std error: 261500

```{r}
autoplot(mod1)
```


Sqft_living as a predictor explains 49% of the variation in the price level. In addition, this predictor is also significant. For every increase in price by $1, sqft_living increases by 280.62 

price = -43580 + 280.62sqft_living
 

# Extensions

* Consider possible interactions between your four main effect predictors and test their effect upon $r^2$. Choose your best candidate interaction and visualise its effect. 

* Calculate the relative importance of predictors from your best $4$-predictor model (i.e. the model without an interaction). Which predictor affects `price` most strongly?

